using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Alba;
using HelpDesk.Api.Demos;
using Microsoft.AspNetCore.TestHost;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Time.Testing;

namespace HelpDesk.Tests.Demos;
public class StillOpenTests : IAsyncLifetime
{   // implementing IAsyncLifetime on a test class (not a fixture) 
    // is a way to have common async setup between the facts in the test,
    // but it is still run for each test. (A new host is created, configured, etc)
    // other test libraries have "TestSetup" or something like that - this is that.
    private IAlbaHost Host { get; set; } = null!;
    private FakeTimeProvider FakeClock { get; set; } = null;
    public async Task InitializeAsync()
    {
        FakeClock = new FakeTimeProvider(new DateTimeOffset(1969, 4, 20, 16, 59, 59, TimeSpan.FromHours(-5)));
        Host = await AlbaHost.For<Program>(config =>
        {
            config.UseSetting("services:software:http:0","https://not-real");
            config.ConfigureTestServices(sp =>
            {
                sp.AddSingleton<TimeProvider>(_ => FakeClock);
            });
        });
    }
    public async Task DisposeAsync()
    {
        await Host.DisposeAsync();
    }

    [Fact]
    public async Task WhenWeAreStillOpen()
    {

        FakeClock.AdjustTime(new DateTimeOffset(1969, 4, 20, 16, 59, 59, TimeSpan.FromHours(-5)));
        var response = await Host.Scenario(api =>
        {
            api.Get.Url("/demos/still-open");
            api.StatusCodeShouldBe(200);
        });

        var body = response.ReadAsJson<BusinessHoursResponse>();
        Assert.NotNull(body);
        Assert.True(body.StillOpen);
    }
    [Fact]
    public async Task WhenWeAreClosed()
    {
        // FakeClock.Advance(TimeSpan.FromMinutes(2)); 
        FakeClock.AdjustTime(new DateTimeOffset(1969, 4, 20, 17, 00, 00, TimeSpan.FromHours(-5)));// move the clock two minutes ahead
        var response = await Host.Scenario(api =>
        {
            api.Get.Url("/demos/still-open");
            api.StatusCodeShouldBe(200);
        });

        var body = response.ReadAsJson<BusinessHoursResponse>();
        Assert.NotNull(body);
        Assert.False(body.StillOpen);
    }


}
